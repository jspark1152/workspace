# -*- coding: utf-8 -*-

from numpy import dot
from numpy.linalg import norm
from sentence_transformers import SentenceTransformer
model = SentenceTransformer('sentence-transformers/xlm-r-100langs-bert-base-nli-stsb-mean-tokens')

#코사인 유사도 출력 함수
def cos_sim(A, B):
    return dot(A, B)/(norm(A)*norm(B))

#Recall Score 함수
def recall_score(list_ref, list_out):
    a = len(list_ref)
    b = len(list_out)
    sum = 0

    for i in range(a):
        max = 0
        em_ref = model.encode(list_ref[i])
        for j in range(b):
            em_out = model.encode(list_out[j])
            cs = cos_sim(em_ref, em_out)
            if cs >= max:
                max = cs
        sum += max

    result = sum / a
    return result

#Precision Score 함수
def precision_score(list_ref, list_out):
    a = len(list_ref)
    b = len(list_out)
    sum = 0

    for i in range(b):
        max = 0
        em_out = model.encode(list_out[i])
        for j in range(a):
            em_ref = model.encode(list_ref[j])
            cs = cos_sim(em_ref, em_out)
            if cs >= max:
                max = cs
        sum += max

    result = sum / b
    return result

#BERT Score 출력 함수
def bert_score(list_ref, list_out):
    r = recall_score(list_ref, list_out)
    print("Recall Score : ", r)
    p = precision_score(list_ref, list_out)
    print("Precision Score : ", p)
    result = (2*r*p)/(r+p)
    print("BERT Score : ", result)

gpt_output = '''
항생제 처방은 지역 사회에서 중요한 문제이며, 특히 호흡기 감염에 많이 사용됩니다. 항생제 오남용은 오랫동안 사회적 문제로 논의되어왔고, 우리나라에서도 항생제 사용량을 관리하기 위해 정책적인 관심이 있습니다. 건강보험심사평가원은 항생제 처방률을 평가하고 결과를 공개하여 의료기관 간의 경쟁을 유도하고 항생제 사용을 줄이는 것을 목표로 하고 있습니다. 이 연구는 항생제 처방률 공개의 효과를 분석하기 위해 의료기관별 처방률의 변동을 분석하고자 합니다. 연구 결과는 항생제 처방률이 공개 후에 감소하는 것을 보여줍니다. 이러한 결과는 항생제 처방률 공개의 효과를 지속적으로 분석할 수 있음을 보여줍니다.
'''
output = '''
이 연구는 지역사회 항생제 사용 관리와 관련한 정책 중 하나인 의료기관별 항생제 처방률 공개의 효과를 분석합니다. 영국에서의 자료에 따르면, 대부분의 항생제가 지역사회에서 사용되며, 그 중 절반 이상이 호흡기 감염에 사용됩니다. 이 중 급성호흡기감염은 주로 바이러스로 인해 발생하며, 항생제의 사용이 효과적이지 않아 오남용으로 인한 내성 개발 우려가 있습니다. 한국에서는 항생제 오남용 문제가 심각했고, 의약분업 이후 항생제는 가장 문제로 부각되었습니다. 폐렴구균의 내성이 높은 상황에서, 건강보험심사평가원은 약제급여적정성평가를 통해 항생제 처방을 감시하고자 했습니다. 특히, 2006년에 급성상기도감염에 대한 항생제 처방률이 공개되어, 이로 인한 의료기관 간 경쟁과 소비자 정보 제공으로 처방률이 감소했습니다. 이 연구는 의료기관별 항생제 처방률의 공개가 처방률 감소에 미친 영향을 추정하기 위해, 단절시계열의 구간회귀분석을 적용합니다. 분석 결과, 처방률 공개 이후 항생제 사용이 감소한 것으로 나타났고, 이 변화는 지속적이었습니다. 이러한 분석은 항생제 관리 정책의 효과를 평가하고, 다른 국가에서도 참고할 만한 시금석이 될 수 있습니다.
'''

source = '''서 론 1956년 담배가 폐암의 원인이 된다는 보고 이후 구강암, 식도암 등 각종 암과 관상 동맥 질환, 만성 폐질환등의 원인으로 담배의 유해성이 알려지기 시작했다.1) 미국이나 유럽 일부에서는 흡연에 대해 일관된 정책으로규제하였고, 이로 인해 흡연율이 줄어들어 2001년 보고에 의하면 전체 흡연자가 24.1%로 감소하였다.2) 그러나국내는 성인 남자의 흡연율이 1980년도 79.3%였다가1999년 65.1%로 나타나3), 중국, 베트남 등 다른 아시아국가와 마찬가지로 높게 나타나고 있다. 흡연의 폐해가언론을 통해 많이 알려지고 건강에 대한 관심이 증가하면서 담배를 끊으려는 움직임이 예전에 비해 증가하였다. 하지만, 미국 흡연자 중 담배를 끊어야 한다고 생각한 사람이 70%인데 비해2) 국내에서는 54.1%로 나타나높은 흡연율에도 불구하고 금연을 해야 한다는 인식은비교적 낮은 것으로 나타났다.금연에 성공하기 위해서 배우자의 격려 등 지지적 환경이 많을수록, 음주량이 적을수록 성공률이 높다고 외국에서 보고하고 있다. 금연 성공에 영향을 미치는 요인에 대한 결과는 연구 방법과 연구 대상에 따라 다르게나타날 뿐 아니라 사회적 관념에 의한 영향이 많아 국내에 그대로 받아들이기 쉽지 않다. 더구나 국내 금연자에대한 연구는 많지 않으며 대상자도 군인, 학생을 대상으로 하고 있어 일반화하기 어려웠다. 최근 금연 클리닉환자를 대상으로 한 보고가 있지만, 금연 클리닉을 찾은사람들은 여러 번 실패한 사람들이므로 니코틴 의존도가 의사의 도움 없이 금연에 성공한 사람들과 다를 수있다. 더구나 금연 클리닉 방문이나 약물 치료 없이 금연에 성공하는 경우가 많다.4) 담배를 피우고 있는 사람들중 많은 사람이 금연을 하고자 한다. 이들 중 어떤 특성을 가진 사람이 금연에 성공하고 실패하는지에 대하여알 수 있다면 금연에 성공할 수 있는 효율적인 방법을교육하는 데 도움이 되리라 생각한다. 본 연구는 서울시내 20세 이상 성인 중 금연을 시도하였다가 실패한 흡 연자와 1년 이상 금연에 성공한 금연자의 특성을 조사하여 어떤 요인이 금연 성공에 기여하는지 조사하기로 하였다.방 법본 연구는 2001년 10월 20일부터 12월 15일까지 서울시내 20세 이상의 성인 남녀 중 흡연자와 금연자 200명씩을 임의로 개별면접조사(face-to-face personal interview)하여 자료를 수집하였다. 100개비 이상의 흡연 경험이있는 사람 중 현재 매일 담배를 피우는 사람을 흡연자로하였고, 담배를 피다가 지난 1달 동안 전혀 담배를 피지않은 사람을 금연자로 하여 각 200명씩 임의로 선정하여조사하였다. 20세 미만의 청소년, 폐암 등 중증 질환을앓고 있는 경우는 제외하였다. 개별 면접 조사는 연령과성별, 지역을 고려하여 편중되지 않도록 하였다. 지역은서울시를 4개의 권역으로 나누어 이루어졌고, 연령과 성별은 2000년도 통계청 자료에서 서울시 연령별 인구 비례와 동일하게 면접조사가 이루어졌다. 대학교 졸업 이상의 학력을 소지한 사람 12명을 면접원으로 선발, 교육후 조사하였다. 집이나 사무실을 방문하여 조사를 시행하였으며 참여한 사람에게는 소정의 답례를 하였다. 조사한 일시, 소요 시간, 면접 대상의 연락처를 남겨 연구관리자가 면접이 제대로 이루어졌는지 확인하였다. 조사 동의율은 남자는 50%, 여자는 25%로 여성에서 현저히 낮았는데 이는 여성의 흡연에 대한 사회적 통념 때문에 자신의 흡연에 대해 말하기를 기피하는 현상으로 생각되었다. 400명의 연구 대상 중 흡연자에서 과거 1회이상의 금연 시도를 한 경험이 있었던 사람 71명을 금연실패자로, 금연자 중 1년 이상 한 개비의 담배도 피우지않은 사람 97명을 금연 성공자로 정의하여 이들의 결과를 분석하였다.설문은 CDC에서 흡연 설문에 사용하였던 설문지를대부분 인용하였으며, 금연 방법에 대한 질문을 추가하였다. 12명을 대상으로 사전 조사(pilot study)를 시행하였고 문장을 수정한 후 본 조사를 시행하였다. 설문 내용은일일 흡연량, 흡연 기간, 흡연량(pack-year), Fagerström’sTest for Nicotine dependence (FTND)5)였다. 금연 방법, 금단증상에 대해 물었고, 가족 및 친구의 흡연 상태에 대해서조사하였다. 결혼 상태, 월 가구 소득, 교육 정도, 운동횟수, 음주에 대해 물었다. 주 2～3회 이상 운동을 하는지에 따라 운동군과 비운동군으로 구분하였다. 음주는주당 횟수와 1회 음주량으로 일일음주량을 계산하였다.일일 음주량은 ‘전혀 안 마신다’, ‘15 g 미만’, ‘15 g 이상～30 g 미만’, ‘30 g 이상’으로 나누어 비교하였다. 흡연에 대한 태도와 금연이 건강에 미치는 영향에 대해 어떻게 생각하는지를 조사하였다. 또한 Scott Howard Frank와 Stephen J. Zyzanski에 의해 개발되고 번역 보완된 ‘한국어판 BEPSI 설문서’로6,7) 스트레스에 대해 평가하였다.금연 성공군과 금연 실패군에서 직업, 결혼 상태, 교육,월 가구 수입, 하루 흡연량, 금연 시도 횟수, 흡연에 대한태도를 비교하기 위하여 Chi-square 검정을 시행하였다.니코틴 의존도, 평생 흡연량(pack-year) 등은 t-test로 두 군의 차이를 비교하였다. 금연을 시도한 경우 금연 성공에영향을 미치는 요인에 대해 알아보기 위하여 성, 연령,교육, 니코틴 의존도, 친구 중 흡연자 수, 가족 내 흡연자유무, 음주량이 금연 성공에 어떤 영향을 미치는지 로지스틱 회귀 분석을 하였다. 다변량 분석에서 하루 흡연량과 니코틴 의존도가 높은 상관관계를 보였기 때문에, 서로 다른 모델에 넣고 분석을 하였다. 두 모델의 결과가유사하게 나타나 두 변수가 비슷한 정도로 금연 성공에영향을 미친다고 판단하여, 결과에 니코틴 의존도만 포함된 모델만을 제시하였다. 통계 package는 SAS window한글 version 8.01와 SPSS 11.0을 이용하였다.결 과표 1에서 금연시도자 중 금연 성공자와 금연 실패자의특성을 비교하였다. 연령, 성별, 결혼상태, 월 가구 수익은 차이를 보이지 않았지만 교육 수준은 금연 성공자에서 12년 이상 교육을 받은 사람이 더 많게 나타났다(P=0.033). 주 2～3회 이상 규칙적으로 운동을 하는 사람은두 군에서 비슷하게 나타났다. 하루 음주량(g/d)은 30 g이상 음주를 하는 사람이 금연 성공자에서 더 적게 나타났다(P=0.005).총 흡연기간은 금연 실패자가 약간 길었으나, 유의한차이는 아니었다. 흡연량과 pack-year는 금연 성공자에서적은 것으로 나타났고(P=0.001, P=0.006), Fagerstrom score로 본 니코틴 의존도는 금연 성공자에서 낮았다(P=0.001). 성공적 금연에 영향을 미치는 사회적 지지는 가까운 친구 5명 중 흡연자 수와 가족 중 흡연자 유무로보았다. 가족 중 흡연자는 두 군에서 차이를 보이지 않았지만, 금연 성공자에서 가까운 친구 5명 중 흡연자의 수가 적었다(P=0.004).대부분 금연 성공자는 4회 이하의 금연 시도로 금연에성공하는 것으로 나타났으며, 금연 실패자에 비해 금연시도를 한 횟수는 더 많은 것으로 나타났다(P=0.012). 금연 시도방법은 금연 패치 등 방법을 이용하였는지 보았는데 금연 방법을 사용한 정도는 두 군에서 비슷하게 나타났다. 하지만 대부분 금연 패치나 병원을 이용하지 않고 스스로 끊었다고 대답하였다. 금단 증상이 나타난 사람의 비율은 두 군에서 비슷하게 나타났다. 고스트레스군에 해당되는 사람도 두 군에서 차이를 보이지는 않았다(표 2).금연성공에 영향을 미칠 수 있는 요인을 다변량 로지스틱 회귀분석을 하여 보았을 때 니코틴 의존도(Fagerstrom score)가 높을수록(OR=0.784, 95% CI=0.667～0.921),친구 중 흡연자 수가 많을수록(OR=0.681, 95% CI=0.51 1～0.909) 금연에 실패하는 것으로 나타났다(표 3).두 군 모두 금연을 시도했던 사람들이므로 흡연이 건강에 미치는 영향에 대한 생각은 차이를 보이지 않았다.금연을 시도한 이유는 현재나 미래의 건강 때문이라고대답한 사람이 대부분이며 두 군에서는 차이를 보이지않았다. 그러나 흡연에 대한 생각을 물었을 때 타인에게영향을 미칠 수 있다고 한 사람이 금연 성공군에서 더많이 나타났다(P=0.011). 금연에 실패한 사람들에서 흡연이 보다 개인적인 문제라고 생각하였다. 배우자의 압력 때문에 금연을 시도했던 사람들은 금연 실패군에서더 많아 본인의 의지가 금연 성공에 가장 중요하다고 생각되었다(표 4).고 찰금연은 금연에 대한 결심, 금연 행동 그리고 금단 증상을 이기고 난 후 금연을 지속하는 여러 과정이 있고 다양한 행동학적 변화가 필요하다. 따라서 각 과정에 따라여러 요인이 영향을 미칠 수 있다. 과거 연구들에 의하면8,9) 나이, 흡연량, 과거 금연 성공 경험이 가장 많이 금연 성공에 영향을 미친다고 보고하였다. CDC 보고에서는10) 빈곤 지수가 높은 계층에서 흡연율은 높고 금연 성공률이 낮은 것으로 보고하였다. 본 연구 결과 월 가구수입은 금연 성공여부에 따라 차이를 보이지 않았는데이는 경제 수준이 금연 성공에 영향을 미치지 않는다고한 국내 보고와11) 일치하였다. 반면 교육 수준이 높을수록 금연에 성공한 사람이 더 많은 것으로 나타났으나 니코틴 의존도를 보정하면 금연 성공에 대한 연관성이 보이지 않았다. 이는 Jaen 등12)의 연구 결과와 유사한데 학력이 낮은 사람에서 흡연량이 많아서 니코틴 의존도가높기 때문이라 생각된다.하루 음주량은 30 g 이상인 경우 금연에 실패하는 사람이 현저히 많았다. 그러나 니코틴 의존도 등 다른 요인을 보정하면 하루 음주량에 의한 영향이 없어졌다. 흡연은 습관성 음주와 밀접한 관련이 있는데, 흡연과 음주둘 다 습관성 약물 남용의 초기 단계로 보고되고 있다.13)알코올 중독이 있는 사람은 금연에 성공하기 어렵고14),음주량이 많을수록 금연 성공률이 낮다고 외국에서 보고되었다.15) 그러나, 국내 금연클리닉 방문자를 대상으로 한 연구에서도16) 금연 성공에 대한 음주의 영향이 적은 것으로 나타나 본 결과와 유사한 결과를 보였는데 우리나라의 흡연율과 음주율이 높아 음주량의 영향이 상대적으로 적게 나타났으리라 생각된다.일일 흡연량과 니코틴 의존도(Fagerstrom score)는 금연성공자에서 낮았다. 다른 변수를 보정하여도 니코틴 의존도는 금연 성공에 영향을 미치는 요인으로 나타났다.흡연량이 많아지면 니코틴 의존도가 높아지고, 니코틴의존도가 높은 사람은 금연을 시도할 때 금단 증상이 심해 실패할 가능성이 높기 때문에 금연 성공에 영향을 미치는 중요한 요인으로 알려져 있다.17)금연 실패자에 비해 금연 성공자의 금연 시도 횟수가많았다. Hymowitz 등8)은'''
abs_output = '''이 연구는 2001년 서울에서 20세 이상의 성인 흡연자와 금연자를 대상으로, 금연 성공과 실패에 영향을 미치는 요인을 조사한 것이다. 조사 결과, 교육 수준이 높을수록 금연에 성공한 사람이 많았으며, 하루 음주량 30g 이상은 금연에 실패할 확률을 높였다. 니코틴 의존도와 흡연량은 금연 성공자에서 낮았고, 친구 중 흡연자 수가 많을수록 금연에 실패할 가능성이 커졌다. 또한, 금연 시도 횟수가 많을수록 금연에 성공할 가능성이 높아졌으며, 금연 성공자들은 주로 건강 이유로 금연을 시도했다. 이러한 결과는 금연 지원 프로그램의 개발과 개인의 금연 계획에 중요한 인사이트를 제공한다.'''
   
paper = '''
Introduction
임상의의 적절한 임상적 의사결정을 위해서는 환자의 임상 데이터를 쉽게 이용할 수 있어야 합니다. 하지만 일반적으로 전자 의료 기록(EHR)에 있는 환자 데이터는 파편화되어 있고 수동적이기 때문에 이해하기 어렵습니다. 저희는 환자의 데이터를 이해하기 위한 임상의의 인지적 노력을 줄이고 환자에 대한 인사이트를 제공하기 위해 실제 관찰 건강 데이터 탐색 애플리케이션인 REHA라는 프레임워크를 개발하고자 합니다.
 
Method
RHEA는 국내 3차 병원 데이터베이스인 아주대학교 의과대학 데이터베이스의 환자 290만 명의 리얼월드 데이터를 관찰 의료 결과 파트너십-공통 데이터 모델(OMOP-CDM) 형식으로 변환하여 개발되었습니다. 개념 증명 연구로, 대상 코호트를 전 세계에서 두 번째로 치명적인 암인 대장암(CRC) 진단을 받은 환자로 정의했습니다[1]. 표준화된 데이터와 비정형 데이터에서 암 환자에 대한 주요 정보를 추출했습니다. 전자의무기록과 별도로 존재하던 암 레지스트리를 변환한 OMOP-CDM의 측정 테이블을 통해 TNM 병기를 추출했습니다. 화학요법 에피소드 기록의 요법 수준 추상화 도구[2]를 사용하여 화학요법 정보를 요법 수준으로 추출합니다. RHEA는 준비된 환자 데이터를 표와 그래프로 시각화한 대시보드를 R shiny를 사용하여 생성하며, 1) 코호트 수준 시각화, 2) 개인 수준 시각화, 3) 코호트 생성의 세 가지 주요 부분으로 구성됩니다.
 
Results
총 10,258명의 CRC 환자가 확인되었습니다. 16,072건의 병리 보고서에서 암 유형 및 유전자 돌연변이 검사를 포함한 병리 정보가 도출되었습니다. 17,759개의 TNM 병기가 암 등록 정보를 결합하여 MEASUREMENT 테이블에 연결되었습니다. 요법 수준의 화학 요법인 212,327개의 에피소드를 확보하여 EPISODE 테이블에 채웠습니다. RHEA를 통해 환자의 거시적 정보를 시각화한 대시보드를 생성했습니다(그림 1).
 
Conclusions
저희는 암 환자의 종단적 상태를 시각화하기 위해 OMOP-CDM으로 변환된 표준화된 데이터를 사용하는 RHEA라는 표준화된 프레임워크를 개발했습니다. 이 시각화된 정보를 통해 임상의가 암 환자를 보다 심층적으로 모니터링하거나 분석하는 데 도움이 되기를 바랍니다. RHEA는 앞으로 더욱 다양한 의료 데이터를 통합하여 멀티모달 프레임워크로 진화해 나갈 예정입니다.
'''
abstract = '''
우리는 암 환자의 종단적 상태를 나타내기 위해 RHEA라는 표준화된 프레임워크를 개발했습니다. RHEA는 관찰 의료 결과 파트너십 공통 데이터 모델 형식으로 환자의 데이터를 시각화하기 위한 대시보드를 생성합니다. 생성된 대시보드는 환자의 거시적 특성을 제공하기 위해 1) 코호트 수준 시각화, 2) 개인 수준 시각화, 3) 코호트 생성의 세 가지 주요 부분으로 구성됩니다.
'''

#Reference > 토큰화 list_ref
#Output > 토큰화 list_out
#list_ref = gpt_output.split(".")
#list_out = output.split(".")

#논문 원문과 그에 대한 요약
#list_ref = source.split(".")
#list_out = abs_output.split(".")

#실제 논문 및 그 논문의 초록
list_ref = paper.split(".")
list_out = abstract.split(".")


#문자열의 앞뒤 공백과 개행 문자 제거
cleaned_list_ref = [sentence.strip() for sentence in list_ref if sentence.strip()]
cleaned_list_out = [sentence.strip() for sentence in list_out if sentence.strip()]

#print(cleaned_list_ref)
#print(cleaned_list_out)

#print(recall_score(list_ref, list_out))
#print(precision_score(list_ref, list_out))

#bert_score(list_ref, list_out)

bert_score(cleaned_list_ref, cleaned_list_out)